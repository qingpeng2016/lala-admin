{extend name="../../admin/view/main"}

{block name="content"}
<form class="layui-form layui-card" action="{:request()->url()}" data-auto="true" method="post" autocomplete="off">
    <div class="layui-card-body">
        <div class="layui-form-item">
            <label class="layui-form-label">业务名称</label>
            <div class="layui-input-block">
                <input name="name" value='{$vo.name|default=""}' required placeholder="请输入业务名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">签名私钥</label>
            <div class="layui-input-block">
                <input name="business_sign_key" value='{$vo.business_sign_key|default=""}' required placeholder="请输入签名私钥" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">IP白名单</label>
            <div class="layui-input-block">
                <textarea name="ip_whitelist" placeholder="请输入IP白名单，多个用逗号分隔" class="layui-textarea" lay-verify="ipList">{$vo.ip_whitelist|default=""}</textarea>
                <div class="layui-form-mid layui-word-aux">请输入有效的IP地址，多个IP用逗号分隔</div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">notify_url</label>
            <div class="layui-input-block">
                <input name="notify_url" value='{$vo.notify_url|default=""}' required placeholder="请输入notify_url" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="radio" name="status" value="1" title="启用" {if isset($vo.status) and $vo.status eq 1}checked{elseif !isset($vo.status)}checked{/if}>
                <input type="radio" name="status" value="0" title="禁用" {if isset($vo.status) and $vo.status eq 0}checked{/if}>
            </div>
        </div>
        <div class="hr-line-dashed"></div>
        {notempty name='vo.id'}<input type='hidden' value='{$vo.id}' name='id'>{/notempty}
        <div class="layui-form-item text-center">
            <button class="layui-btn" type='submit' lay-submit lay-filter="formSubmit">保存数据</button>
            <button class="layui-btn layui-btn-danger" type='button' data-close>取消编辑</button>
        </div>
    </div>
</form>
{/block}

{block name="script"}
<script>
layui.use(['form'], function(){
    var form = layui.form;
    
    // 自定义验证规则
    form.verify({
        ipList: function(value) {
            var ipList = value.split(',');
            var ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
            
            for(var i = 0; i < ipList.length; i++) {
                var ip = ipList[i].trim();
                if(ip && !ipRegex.test(ip)) {
                    return 'IP地址格式不正确: ' + ip;
                }
                
                // 检查IP地址的每个部分是否在0-255之间
                var parts = ip.split('.');
                for(var j = 0; j < parts.length; j++) {
                    var part = parseInt(parts[j]);
                    if(part < 0 || part > 255) {
                        return 'IP地址数值范围不正确: ' + ip;
                    }
                }
            }
        }
    });
    
    // 监听表单提交
    form.on('submit(formSubmit)', function(data){
        // 手动验证IP白名单
        var ipWhitelist = data.field.ip_whitelist;
        var ipList = ipWhitelist.split(',');
        var ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        
        for(var i = 0; i < ipList.length; i++) {
            var ip = ipList[i].trim();
            if(ip && !ipRegex.test(ip)) {
                layer.msg('IP地址格式不正确: ' + ip);
                return false;
            }
            
            // 检查IP地址的每个部分是否在0-255之间
            var parts = ip.split('.');
            for(var j = 0; j < parts.length; j++) {
                var part = parseInt(parts[j]);
                if(part < 0 || part > 255) {
                    layer.msg('IP地址数值范围不正确: ' + ip);
                    return false;
                }
            }
        }
        
        return true;
    });
});
</script>
{/block} 