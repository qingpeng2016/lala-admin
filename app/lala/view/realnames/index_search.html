<form class="layui-form layui-form-pane form-search" action="{:request()->url()}" onsubmit="return false" method="get" autocomplete="off">
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label">姓名</label>
        <div class="layui-input-inline">
            <input type="text" name="auth_real_name" placeholder="请输入姓名" value="{$get.auth_real_name|default=''}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label">身份证号</label>
        <div class="layui-input-inline">
            <input type="text" name="auth_card_number" placeholder="请输入身份证号码" value="{$get.auth_card_number|default=''}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label">邮箱</label>
        <div class="layui-input-inline">
            <input type="text" name="email" placeholder="请输入邮箱" value="{$get.email|default=''}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline">
        <label class="layui-form-label">手机号码</label>
        <div class="layui-input-inline">
            <input type="text" name="mobile" placeholder="请输入手机号码" value="{$get.mobile|default=''}" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item layui-inline">
        <button class="layui-btn layui-btn-primary"><i class="layui-icon">&#xe615;</i> 搜 索</button>
    </div>
    <div class="layui-form-item layui-inline">
        <button type="button" class="layui-btn layui-btn-normal" onclick="showDownloadDialog()">
            <i class="layui-icon">&#xe601;</i> 下载用户所有信息
        </button>
    </div>
</form>

<script>
function showDownloadDialog() {
    layui.use(['layer'], function(){
        var layer = layui.layer;
        
        layer.prompt({
            formType: 0,
            value: '',
            title: '请输入用户ID',
            area: ['500px', '300px'],
            content: '<div style="padding: 20px;">' +
                     '<p style="margin-bottom: 10px; color: #666;">请输入要下载的用户ID，多个用户ID请用 | 分隔</p>' +
                     '<p style="margin-bottom: 15px; color: #999; font-size: 12px;">例如：123|456|789</p>' +
                     '<textarea id="userIds" placeholder="请输入用户ID，多个用|分隔&#10;每行一个用户ID或使用|分隔" style="width: 100%; height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; font-family: monospace;"></textarea>' +
                     '</div>',
            btn: ['确定下载', '取消'],
            yes: function(index, layero){
                var userIds = layero.find('#userIds').val().trim();
                if (!userIds) {
                    layer.msg('请输入用户ID', {icon: 2});
                    return;
                }
                
                // 验证用户ID格式 - 支持换行符和|分隔符
                var idArray = userIds.split(/[\n|]/);
                var validIds = [];
                for (var i = 0; i < idArray.length; i++) {
                    var id = idArray[i].trim();
                    if (id && /^\d+$/.test(id)) {
                        validIds.push(id);
                    }
                }
                
                if (validIds.length === 0) {
                    layer.msg('请输入有效的用户ID', {icon: 2});
                    return;
                }
                
                // 关闭弹窗
                layer.close(index);
                
                // 调试信息
                console.log('验证后的用户ID:', validIds);
                console.log('传递给downloadData的参数:', validIds.join('|'));
                
                // 执行下载
                console.log('准备调用downloadData函数');
            
                console.log('downloadData函数开始执行，参数:', userIds);
    
    // 使用当前页面的基础URL
    var currentUrl = window.location.href;
    console.log('当前URL:', currentUrl);
    
                    var baseUrl = currentUrl.split('#')[0].split('?')[0]; // 移除hash和查询参数
                console.log('移除hash后的baseUrl:', baseUrl);
                
                // 构建正确的下载URL
                var url = baseUrl.replace('/admin.html', '/lala/realnames/download.html');
                console.log('替换后的URL:', url);
    
    if (userIds) {
        url += '?user_ids=' + encodeURIComponent(userIds);
        console.log('添加参数后的URL:', url);
    }
    
    console.log('最终下载URL:', url);
    
    // 显示加载提示
    layui.use(['layer'], function(){
        var layer = layui.layer;
        var loadIndex = layer.load(1, {shade: [0.3, '#000']});
        
        // 创建隐藏的iframe来下载文件
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        
        console.log('iframe.src:', iframe.src);
        
        // 3秒后移除iframe和加载提示
        setTimeout(function(){
            document.body.removeChild(iframe);
            layer.close(loadIndex);
            layer.msg('下载已开始，请检查浏览器下载列表', {icon: 1});
        }, 3000);
    });
                
                console.log('downloadData函数调用完成');
            }
        });
    });
}

</script>